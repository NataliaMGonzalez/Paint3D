<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RETO</title>
    <style>
        html,
        body {
            width: 100%;
            height: 100%;
            padding: 0;
            margin: 0;
            overflow: hidden;
        }
    </style>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/dat-gui/0.7.7/dat.gui.min.js"></script>
</head>

<body>
    <script type="module">
        import * as THREE from 'https://unpkg.com/three/build/three.module.js';
        import Stats from 'https://unpkg.com/three@0.126.1/examples/jsm/libs/stats.module.js';
        import { OrbitControls } from "https://unpkg.com/three@0.119.0/examples/jsm/controls/OrbitControls.js";

        "using strict";

        class Mesh extends THREE.Mesh {
            constructor() {
                super();
            }
            setWireframe(value) {
                this.material.wireframe = value;
            }
        }

        class Quad extends Mesh {
            constructor() {
                super();
                // QUAD
                let vertices = [-0.5, 0.5, 0,
                -0.5, -0.5, 0,
                    0.5, -0.5, 0,
                    0.5, 0.5, 0];
                let indices = [0, 1, 2, 0, 2, 3];

                this.geometry = new THREE.BufferGeometry();
                this.geometry.setAttribute('position', new THREE.Float32BufferAttribute(vertices, 3));
                this.geometry.setIndex(indices);
                this.material = new THREE.MeshBasicMaterial({ color: "white", wireframe: false, side: THREE.DoubleSide });
            }
        }

        function addHeart() {
            let heartShape = new THREE.Shape();

            const x = 0, y = 0;
            heartShape.moveTo(x, y);
            heartShape.moveTo(x + 5, y + 5);
            heartShape.bezierCurveTo(x + 5, y + 5, x + 4, y, x, y);
            heartShape.bezierCurveTo(x - 6, y, x - 6, y + 7, x - 6, y + 7);
            heartShape.bezierCurveTo(x - 6, y + 11, x - 3, y + 15.4, x + 5, y + 19);
            heartShape.bezierCurveTo(x + 12, y + 15.4, x + 16, y + 11, x + 16, y + 7);
            heartShape.bezierCurveTo(x + 16, y + 7, x + 16, y, x + 10, y);
            heartShape.bezierCurveTo(x + 7, y, x + 5, y + 5, x + 5, y + 5);

            let geometry = new THREE.ShapeGeometry(heartShape);
            // material = new THREE.MeshPhongMaterial( { color: "white", wireframe: true } );
            let material = new THREE.MeshBasicMaterial({ color: "white", wireframe: true });
            let mesh = new THREE.Mesh(geometry, material);
            mesh.position.x = randomNumber();

            return mesh;
        }

        function addFish() {
            let fishShape = new THREE.Shape();

            const x = 0, y = 0;

            fishShape.moveTo(x, y);
            fishShape.quadraticCurveTo(x + 50, y - 80, x + 90, y - 10);
            fishShape.quadraticCurveTo(x + 100, y - 10, x + 115, y - 40);
            fishShape.quadraticCurveTo(x + 115, y, x + 115, y + 40);
            fishShape.quadraticCurveTo(x + 100, y + 10, x + 90, y + 10);
            fishShape.quadraticCurveTo(x + 50, y + 80, x, y);

            let geometry = new THREE.ShapeGeometry(fishShape);

            let material = new THREE.MeshBasicMaterial({ color: "white", wireframe: true });
            let mesh = new THREE.Mesh(geometry, material);
            mesh.position.x = randomNumber();

            return mesh;
        }

        function addDonut() {
            let donutShape = new THREE.Shape();

            const x = 0, y = 0;

            donutShape.moveTo(50, 10);
            donutShape.absarc(10, 10, 40, 0, Math.PI * 2, false);

            let holePath = new THREE.Path();
            holePath.moveTo(20, 10);
            holePath.absarc(10, 10, 10, 0, Math.PI * 2, true);

            donutShape.holes.push(holePath);

            let geometry = new THREE.ShapeGeometry(donutShape);

            let material = new THREE.MeshBasicMaterial({ color: "white", wireframe: true });
            let mesh = new THREE.Mesh(geometry, material);
            mesh.position.x = randomNumber();

            return mesh;

        }


        let rendered, scene, camera, cameraControl, stats;
        let mesh;
        let objects = [];
        let nModels = 0, positions = [0, 20, -20, 40, -40, 60, -60, 80, -80, 100];

        function randomNumber() {
            return positions[nModels];
        }

        function createObject(objectType) {
            let geometry, material, mesh;

            switch (objectType) {
                case "pyramid":
                    geometry = new THREE.CylinderGeometry(0, 1, 1, 4, 1);
                    material = new THREE.MeshBasicMaterial({ color: "white", wireframe: true });
                    mesh = new THREE.Mesh(geometry, material);
                    mesh.position.x = randomNumber();
                    break;
                case "cube":
                    geometry = new THREE.BoxGeometry();
                    material = new THREE.MeshBasicMaterial({ color: "white", wireframe: true });
                    mesh = new THREE.Mesh(geometry, material);
                    mesh.position.x = randomNumber();
                    break;
                case "sphere":
                    geometry = new THREE.SphereGeometry();
                    material = new THREE.MeshBasicMaterial({ color: "white", wireframe: true });
                    mesh = new THREE.Mesh(geometry, material);
                    mesh.position.x = randomNumber();
                    break;
                case "quad":
                    mesh = new Quad();
                    break;
                case "heart":
                    mesh = addHeart();
                    break;
                case "fish":
                    mesh = addFish();
                    break;
                case "donut":
                    mesh = addDonut();
                    break;
            }

            nModels = nModels + 1;

            mesh.position.y = 1;
            return mesh;
        }

        function init() {

            // RENDERER
            rendered = new THREE.WebGLRenderer({ antialias: true });
            rendered.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(rendered.domElement);

            // SCENE
            scene = new THREE.Scene();

            // CAMERA 
            let fov = 60;
            let aspect = window.innerWidth / window.innerHeight;
            let near = 0.1;
            let far = 10000;
            camera = new THREE.PerspectiveCamera(fov, aspect, near, far);
            camera.position.set(0, 0, 50);
            cameraControl = new OrbitControls(camera, rendered.domElement);

            // PLANEHELPER
            let normal = new THREE.Vector3(0, 1, 0);
            let distanceToPlane = 0.;
            let plane = new THREE.Plane(normal, distanceToPlane);
            let planeHelper = new THREE.PlaneHelper(plane, 30, "white");
            scene.add(planeHelper);

            // STATS
            stats = new Stats();
            document.body.appendChild(stats.dom);

            // GUI 
            let gui = new dat.GUI()

            let showModels = {
                addPyramid: function () {
                    if (nModels < 10) {
                        mesh = createObject("pyramid")
                        scene.add(mesh);
                        objects.push(mesh);
                    } else {
                        alert("Oops! Máximo se pueden 10 figuras geometricas");
                    }
                },
                addCube: function () {
                    if (nModels < 10) {
                        mesh = createObject("cube")
                        scene.add(mesh);
                        objects.push(mesh);
                    } else {
                        alert("Oops! Máximo se pueden 10 figuras geometricas");
                    }
                },
                addSphere: function () {
                    if (nModels < 10) {
                        mesh = createObject("sphere")
                        scene.add(mesh);
                        objects.push(mesh);
                    } else {
                        alert("Oops! Máximo se pueden 10 figuras geometricas");
                    }
                },
                addQuad: function () {
                    if (nModels < 10) {
                        mesh = createObject("quad")
                        scene.add(mesh);
                        objects.push(mesh);
                    } else {
                        alert("Oops! Máximo se pueden 10 figuras geometricas");
                    }
                },
                addHeart: function () {
                    if (nModels < 10) {
                        mesh = createObject("heart")
                        scene.add(mesh);
                        objects.push(mesh);
                    } else {
                        alert("Oops! Máximo se pueden 10 figuras geometricas");
                    }
                },
                addFish: function () {
                    if (nModels < 10) {
                        mesh = createObject("fish")
                        scene.add(mesh);
                        objects.push(mesh);
                    } else {
                        alert("Oops! Máximo se pueden 10 figuras geometricas");
                    }
                },
                addDonut: function () {
                    if (nModels < 10) {
                        mesh = createObject("donut")
                        scene.add(mesh);
                        objects.push(mesh);
                    } else {
                        alert("Oops! Máximo se pueden 10 figuras geometricas");
                    }
                },

            }

            // RAYCASTER
            document.addEventListener('mousedown', onDocumentMouseDown);
            //let mesh;

            function onDocumentMouseDown(event) {
                event.preventDefault();
                var mouse3D = new THREE.Vector3((event.clientX / window.innerWidth) * 2 - 1,
                    -(event.clientY / window.innerHeight) * 2 + 1, 0.5);
                var raycaster = new THREE.Raycaster();
                raycaster.setFromCamera(mouse3D, camera);
                var intersects = raycaster.intersectObjects(objects);
                // console.log(intersects)
                if (intersects.length > 0) {
                    //let color = Math.random() * 0xffffff;
                    //intersects[0].object.material.color.setHex(color);
                    mesh = intersects[0].object;

                    model.name = mesh.name;
                    model.colorPalette = [mesh.material.color.r * 255, mesh.material.color.g * 255, mesh.material.color.b * 255];
                    model.posX = mesh.position.x;
                    model.posY = mesh.position.y;
                    model.posZ = mesh.position.z;
                    model.rotX = mesh.rotation.x / Math.PI * 180;
                    model.rotY = mesh.rotation.y / Math.PI * 180;
                    model.rotZ = mesh.rotation.z / Math.PI * 180;
                    model.wireframe = mesh.material.wireframe;
                }
            }

            // MODEL
            let model = {
                name: "name",
                posX: 0,
                posY: 0,
                posZ: 0,
                rotX: 0,
                rotY: 0,
                rotZ: 0,
                wireframe: true,
                colorPalette: [255, 255, 255]
            }

            let pageDesign = {
                colorPalette: [255, 255, 255],
                showStats: true
            }

            // MENUS
            let generalMenu = gui.addFolder("Scene appereance");
            let addModels = gui.addFolder("Add models");
            addModels.open();

            // add models buttons
            let btnAddPyramid = addModels.add(showModels, "addPyramid").name("Add Pyramid")
            let btnAddCube = addModels.add(showModels, "addCube").name("Add Cube")
            let btnAddSphere = addModels.add(showModels, "addSphere").name("Add Sphere")
            let btnAddQuad = addModels.add(showModels, "addQuad").name("Add Quad")
            let btnAddHeart = addModels.add(showModels, "addHeart").name("Add Heart")
            let btnAddFish = addModels.add(showModels, "addFish").name("Add Fish")
            let btnAddDonut = addModels.add(showModels, "addDonut").name("Add Donut")

            // Position Menu
            let posMenu = gui.addFolder("Position Menu");
            posMenu.open();

            // Model Position
            let sliderPosX = posMenu.add(model, "posX").min(-100).max(+100).step(0.5).name("X").listen().onChange(function (value) {
                mesh.position.x = value;
            })

            let sliderPosY = posMenu.add(model, "posY").min(-100).max(+100).step(0.5).name("Y").listen().onChange(function (value) {
                mesh.position.y = value;
            })

            let sliderPosZ = posMenu.add(model, "posZ").min(-100).max(+100).step(0.5).name("Z").listen().onChange(function (value) {
                mesh.position.z = value;
            })

            // Rotation Menu
            let rotMenu = gui.addFolder("Rotation Menu");
            rotMenu.open();

            // Model rotation
            let sliderRotY = rotMenu.add(model, "rotY").min(-360).max(+360).step(10).name("Rotation Y (deg)").listen().onChange(function (value) {
                mesh.rotation.y = value * Math.PI / 180
            });

            let sliderRotX = rotMenu.add(model, "rotX").min(-360).max(+360).step(10).name("Rotation X (deg)").listen().onChange(function (value) {
                mesh.rotation.x = value * Math.PI / 180
            });

            let sliderRotZ = rotMenu.add(model, "rotZ").min(-360).max(+360).step(10).name("Rotation Z (deg)").listen().onChange(function (value) {
                mesh.rotation.z = value * Math.PI / 180
            });

            // Apperance Menu
            let appearMenu = gui.addFolder("Appearance Menu");
            appearMenu.open();

            let colorPalette = appearMenu.addColor(model, "colorPalette").name("Color Palette").listen().onChange(function (color) {
                mesh.material.color = new THREE.Color(color[0] / 256, color[1] / 256, color[2] / 256);
            });

            let chbWireframe = appearMenu.add(model, "wireframe").setValue(true).name("Wireframe").onChange(function (value) {
                mesh.material.wireframe = value;
            });


            /* let tfMeshName = appearMenu.add(model, "name").name("Model's Name").onChange(function (value) {
                console.log(mesh.name);
                mesh.name = value;
            }); */


            // show plane checkbox
            let chbPlaneHelper = generalMenu.add(planeHelper, "visible").setValue(false).name("Show PlaneHelper");

            // show stats checkbox
            let chbStats = generalMenu.add(pageDesign, "showStats").setValue(true).name("Show Stats").onChange(function (value) {
                if (value) {
                    stats.showPanel(0);
                } else {
                    stats.showPanel(-1);
                }
            });

            // change background color
            let clrPalette = generalMenu.addColor(pageDesign, "colorPalette").name("Color Background").onChange(function (color) {
                rendered.setClearColor(new THREE.Color(color[0] / 256, color[1] / 256, color[2] / 256))
            });

            gui.close();

            renderLoop();
        }

        function renderLoop() {
            stats.begin();
            rendered.render(scene, camera); //DRAW SCENE
            stats.end();
            stats.update();
            requestAnimationFrame(renderLoop);
        }

        // EVENT LISTENERS & HANDLERS
        document.addEventListener("DOMContentLoaded", init);

        window.addEventListener("resize", function () {
            rendered.setSize(window.innerWidth, window.innerHeight);
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
        });

    </script>
</body>

</html>